name: Deploy to Azure App Service

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AZURE_WEBAPP_NAME: seima-server
  JAVA_VERSION: '21'
  DISTRIBUTION: 'temurin'

jobs:
  test:
    runs-on: ubuntu-latest
    name: Unit Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.DISTRIBUTION }}
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Run Unit Tests
      run: |
        echo "ğŸ§ª Running unit tests..."
        ./mvnw clean test -Dspring.profiles.active=test
        
    - name: Generate Test Report
      run: |
        echo "ğŸ“Š Generating test reports..."
        ./mvnw surefire-report:report-only
        
    - name: Publish Test Results
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Unit Test Results
        path: target/surefire-reports/*.xml
        reporter: java-junit
        fail-on-error: true
        
    - name: Upload Test Coverage Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-coverage-reports
        path: |
          target/surefire-reports/
          target/site/
        retention-days: 30
        
    - name: Test Summary
      if: always()
      run: |
        echo "ğŸ“‹ Test Execution Summary:"
        if [ -f target/surefire-reports/TEST-*.xml ]; then
          echo "âœ… Unit tests completed"
          test_count=$(grep -o 'tests="[0-9]*"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]*' | head -1)
          failures=$(grep -o 'failures="[0-9]*"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]*' | head -1)
          errors=$(grep -o 'errors="[0-9]*"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]*' | head -1)
          echo "ğŸ“Š Total tests: ${test_count:-0}"
          echo "âŒ Failures: ${failures:-0}"
          echo "ğŸ’¥ Errors: ${errors:-0}"
        else
          echo "âŒ No test results found"
        fi

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    name: Build and Deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.DISTRIBUTION }}
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Build with Maven
      run: |
        echo "ğŸ”¨ Building application..."
        ./mvnw clean package -Dspring.profiles.active=prod -DskipTests
      
    - name: List built files
      run: |
        echo "ğŸ“¦ Built artifacts:"
        ls -lh ./target/*.jar
      
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: './target/seima-server-0.0.1-SNAPSHOT.jar'
        
    - name: Notify deployment success
      run: |
        echo "ğŸš€ Deployment completed successfully!"
        echo "ğŸ“¦ Spring Boot JAR deployed to Azure App Service"
        echo "ğŸ”— App URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"

  build-only:
    runs-on: ubuntu-latest
    needs: test
    name: Build Only (PR)
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.DISTRIBUTION }}
        
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Build with Maven
      run: |
        echo "ğŸ”¨ Building application for PR validation..."
        ./mvnw clean package -Dspring.profiles.active=test -DskipTests
        
    - name: Validate build artifacts
      run: |
        echo "âœ… Build validation completed for PR"
        ls -lh ./target/*.jar
